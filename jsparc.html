<!doctype html>
<html>
 <head>
  <link rel="icon" type="image/vnd.microsoft.icon" href="images/favicon.ico">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>jSparc v0.4.3</title>
  <link rel="stylesheet" type="text/css" media="screen" href="styles/jquery.jqplot.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="styles/OpenLayers-2.12.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="jsparc.css" />
  <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="scripts/excanvas.js"></script><![endif]-->
  <script type="text/javascript" src="scripts/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="scripts/OpenLayers-2.13b.min.js"></script>
  <script type="text/javascript" src="scripts/jquery.jqplot.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.cursor.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasTextRenderer.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
  <script type="text/javascript" src="jsparc.js"></script>
  <script type="text/javascript">
    var URL = "http://data.hisparc.nl/jsparc/";
    var MIPdens = [];
    var detNum = [];
    var infoURL = [];
    var get_coincidence = {};
    get_coincidence.session_title = "";
    get_coincidence.session_pin = "";
    get_coincidence.student_name = "";
    var htmlInfo = {
        mapId: "map-id",
        distId: "dist",
        chartId: "chartdiv",
        mipId: "MIP",
        mipCalcId: "MIPcalc",
        energyId: "showEn",
        stationEr: "showEr",
        showerEr: "measEr"};
    var diagramColor = ["#600", "#f00", "#f90", "#ff0",
                        "#6f0", "#6ff", "#f0f", "#ccc"];
    var traceColor = ["#222", "#D22", "#1C2", "#1CC"];
    var Dataflag = true;

    function padZero(number, length) {
        var str = '' + number;
        while (str.length < length) {
            str = '0' + str;}
        return str;
    }
    
    function showEvent(i) {
        for (u = 0; u < 8; u++) {
            if (u != i) {
                $("#chartdiv" + u).hide();}}
        $("#chartdiv" + i).show();
    }
    
    function calcMIP() {
        for (i = 0; i < MIPdens.length; i++) {
            $('#MIP' + i).val((2 * MIPdens[i] / $('#count' + i).val()).toFixed(3));}
    }
    
    function getStatus(i) {
        window.open(infoURL[i]);
    }

    function timestampToDate(timestamp) {
        var date = new Date(timestamp * 1000);
        var year = date.getUTCFullYear();
        var month = date.getUTCMonth() + 1;
        var day = date.getUTCDate();
        var hour = date.getUTCHours();
        var minute = date.getUTCMinutes();
        var second = date.getUTCSeconds();
        var datumOut = year + "/" + padZero(month, 2) + "/" + padZero(day, 2) + " " + padZero(hour, 2) + ":" + padZero(minute, 2) + ":" + padZero(second, 2);
        return datumOut;
    }
    
    function timestampToGMST(timestamp) {
        var sidDays = timestamp / 86400 - 10957;
        var GMST = 18.697374558 + 24.06570982441908 * sidDays; // http://en.wikipedia.org/wiki/Sidereal_time
        var hours = parseInt(GMST, 10);
        var minutes = (GMST - hours) * 60;
        var seconds = (minutes - parseInt(minutes)) * 60;
        seconds = (parseInt(0.5 + seconds * 10)) / 10;
        minutes = parseInt(minutes);
        sidDays = parseInt(hours / 24, 10);
        hours = hours - 24 * sidDays;
        GMST = sidDays + " " + padZero(hours, 2) + ":" + padZero(minutes, 2) + ":" + padZero(seconds, 2);
        return GMST;
    }

    function loadData(data) {
        $("#dataButton").hide();
        $("#exampleButton").hide();
        Dataflag = false;
        detNum = detectorNumber(data);
        stationNumber = data.events.length;
        makeShowerMap(htmlInfo, data);
        plotGraph(htmlInfo, data);
        // interactionTrace(data);

        // Disable session options
        $('#sessionTitle').attr('disabled', true);
        $('#sessionPin').attr('disabled', true);
        $('#studentName').attr('disabled', true);

        $("#datum-id").css('visibility', 'visible');
        $("#result-id").css('visibility', 'visible');
        $("#tracelegend").css('visibility', 'visible');
        
        //  Get Year, Month, Day, Hour, Minute, Second.
        var datum = timestampToDate(data.events[0].timestamp);
        $("#datum").html(datum);

        // Greenwich Mean Sidereal Time in hours
        var GMST = timestampToGMST(data.events[0].timestamp);
        $("#gmst").html(GMST);

        // Write information to dashboard
        var tabWidth = 1 + data.events.length;
        var txt = "<tr><td colspan='" + tabWidth + "'>Station</td></tr><tr><td></td>";
        for (i = 0; i < data.events.length; i++) {
            txt += "<td onclick='getStatus(" + i + ")' style='cursor: pointer; text-align: center; border-radius: 2px; background-color:" + diagramColor[i] + ";";
            if (i < 2) {
                txt += " color:#fff;";}
            txt += "'>" + data.events[i].number;}
        txt += "</td></tr><tr><td colspan='" + tabWidth + "'>Distance to shower in [m]</td></tr><tr><td></td>";
        for (i = 0; i < data.events.length; i++) {
            txt += "<td><input type='text' id='dist" + i + "' disabled='disabled' size=5></td>";
            MIPdens[i] = 0;}
        txt += "</tr><tr><td colspan='" + tabWidth + "'>Detectorflux in [MIP/m<sup>2</sup>]</td></tr>";
        for (j = 0; j < 4; j++) {
            txt += "<tr><td align='center' class='det" + (j + 1) + "' style='border-radius:2px;'>" + (1 + j) + "</td>";
            for (i = 0; i < data.events.length; i++) {
                if (j < detNum[i]) {
                    if (data.events[i].pulseheights[j] * data.events[i].integrals[j] !== 0) {
                        MIPdens[i] = data.events[i].mips[j] + MIPdens[i];
                        txt += "<td><input id='MIP" + i + j + "' type='text' value=" + (2 * data.events[i].mips[j]).toFixed(3) + " disabled='disabled' size=5></td>";}
                    else {
                        txt += "<td><input id='MIP" + i + j + "' type='text' value='no data' style='color:#f33; -webkit-text-fill-color: #f33;' disabled='disabled' size=5></td>";}}
                else {
                    txt += "<td></td>";}}
            txt += "</tr>";}
        txt += "<tr><td></td>";
        for (i = 0; i < data.events.length; i++) {
            txt += "<td><select id='count" + i + "' onchange='calcMIP()'>";
            for (j = detNum[i]; j > 0; j--) {
                txt += "<option value=" + j + ">" + j + "</option>";}
            txt += "</select></td>";}
        txt += "</tr><tr><td colspan='" + tabWidth + "'>Stationflux in [MIP/m<sup>2</sup>]</td></tr><tr><td>Data</td>";
        for (i = 0; i < data.events.length; i++) {
            txt += "<td><input type='text' id='MIP" + i + "' value=" + (MIPdens[i] / 2).toFixed(3) + " disabled='disabled' size=5></td>";}
        txt += "</tr><tr><td>Calc.</td>";
        for (i = 0; i < data.events.length; i++) {
            txt += "<td><input type='text' id='MIPcalc" + i + "' disabled='disabled' size=5></td>";
            $("#choice" + i).html(data.events[i].number).show().css('visibility', 'visible');
            infoURL[i] = "http://data.hisparc.nl/show/stations/" + data.events[i].number + "/" + datum.substring(0, 10) + "/";}
        $(txt).appendTo("#coinInfo");
        $('<input type="button" value="Send result" id="sendButton" onclick="sendResult()">').appendTo('#info');

        showEvent(0);
        $("#choice").on("click", "td", function(event) {showEvent($(this).index());});
        writeDist(htmlInfo, showerMerc, data);
    }

    function showError(data) {
        if (data.status === 0) {
            alert('An error occured, try again');}
        else {
            json = JSON.parse(data.responseText);
            alert(json.message);}
    }

    function retrieveData(htmlInfo, URL) {
        $.getJSON(URL + "get_coincidence/", get_coincidence)
            .done(loadData)
            .fail(showError);
    }

    function getExample() {
        $("#sessionTitle").val('example');
        $("#sessionPin").val('1337');
        $("#studentName").val('test');
        get_coincidence.session_title = $("#sessionTitle").val();
        get_coincidence.session_pin = $("#sessionPin").val();
        get_coincidence.student_name = $("#studentName").val();
        if (Dataflag) {
            retrieveData(htmlInfo, URL);}
    }

    function getData() {
        if ($("#sessionTitle").val() === "" || $("#sessionPin").val() === "" || $("#studentName").val() === "") {
            alert("Fill in each field");}
        else {
            get_coincidence.session_title = $("#sessionTitle").val();
            get_coincidence.session_pin = $("#sessionPin").val();
            get_coincidence.student_name = $("#studentName").val();
            if (Dataflag) {
                retrieveData(htmlInfo, URL);}}
    }

    $(function() {
        // Animate HiSPARC logo during ajax activity
        $(document).bind('ajaxStart', function() {
                            $('#pageHeader').addClass('animated');})
                   .bind('ajaxStop', function() {
                            $('#pageHeader').removeClass('animated');});

        $("#sessionHash").val(get_coincidence.session_hash);

        $("#exampleButton").bind('click', function (event) {
            getExample();
        });

        $("#dataButton").bind('click', function (event) {
            getData();
        });

        $(window).keyup(function (e) {
            if (e.keyCode === 13) {
                getData();}
        });
    });
  </script>
 </head>
<body>
    <div id="graph-id">
        <div id="chartdiv" class="coincidencegraph"></div>
        <table id="choice">
            <tr>
                <td id="choice0">&nbsp;</td>
                <td id="choice1"></td>
                <td id="choice2"></td>
                <td id="choice3"></td>
                <td id="choice4"></td>
                <td id="choice5"></td>
                <td id="choice6"></td>
                <td id="choice7"></td>
            </tr>
        </table>
        <div id="chartdiv0" class="tracegraph"></div>
        <div id="chartdiv1" class="tracegraph"></div>
        <div id="chartdiv2" class="tracegraph"></div>
        <div id="chartdiv3" class="tracegraph"></div>
        <div id="chartdiv4" class="tracegraph"></div>
        <div id="chartdiv5" class="tracegraph"></div>
        <div id="chartdiv6" class="tracegraph"></div>
        <div id="chartdiv7" class="tracegraph"></div>
        <table id="tracelegend">
            <tr>
                <td class="det1">Detector 1</td>
                <td class="det2">Detector 2</td>
                <td class="det3">Detector 3</td>
                <td class="det4">Detector 4</td>
            </tr>
        </table>
    </div>
    <div id="datum-id">UTC Date: <span id="datum"></span>GMST: <span id="gmst"></span></div>
    <div id="map-id"></div>
    <div id="result-id">Energy in [eV]:<input type="text" id="showEn" disabled="disabled" size=8> <a style="font-family: serif;">&#967;</a><sup>2</sup>:<input type="text" id="showEr" disabled="disabled" size=8></div>
    <div id="logo"><a target="_blank" href="http://www.hisparc.nl/"><span id="pageHeader"></span></a></div>
    <div id="doc_link">
        <a href="http://docs.hisparc.nl/jsparc/jsparc_analysis.html" target="jsparc_doc">➔ Documentation</a>
    </div>
    <div id="dashboard">
        <form>
            <table>
                <tr><td>Title</td><td><input type="text" id="sessionTitle"></td></tr>
                <tr><td>Pin</td><td><input type="text" id="sessionPin"></td></tr>
                <tr><td>Name</td><td><input type="text" id="studentName"></td></tr>
            </table>
        </form>
        <input type="button" id="dataButton" value="Get data">
        <input type="button" id="exampleButton" value="Get example">
        <form id="info">
            <table id="coinInfo">
            </table>
        </form>
    </div>
</body>
</html>
