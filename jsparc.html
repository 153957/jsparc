<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN" "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>jSparc v0.4.2</title>
  <link rel="stylesheet" type="text/css" media="screen" href="scripts/jquery.jqplot.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="scripts/OpenLayers-2.12.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="jsparc.css" />
  <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="scripts/excanvas.js"></script><![endif]-->
  <script type="text/javascript" src="scripts/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="scripts/OpenLayers-2.13b.min.js"></script>
  <script type="text/javascript" src="scripts/jquery.jqplot.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.cursor.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasTextRenderer.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
  <script type="text/javascript" src="star.js"></script>
  <script type="text/javascript" src="jsparc.js"></script>
  <script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
  <script type="text/javascript">

    var URL = "http://data.hisparc.nl/django/jsparc/";
    var MIPdens = [];
    var detNum = [];
    var infoURL = [];
    var get_coincidence = {};
    get_coincidence.session_title = "";
    get_coincidence.session_pin = "";
    get_coincidence.student_name = "";
    var htmlInfo = {
        mapId: "map-id",
        distId: "dist",
        chartId: "chartdiv",
        mipId: "MIP",
        mipCalcId: "MIPcalc",
        energyId: "showEn",
        stationEr: "showEr",
        showerEr: "measEr"};

    function padZero(number, length) {
        var str = '' + number;
        while (str.length < length) {
            str = '0' + str;}
        return str;
    }
    
    function showEvent(i) {
        for (u = 0; u < 8; u++) {
            if (u != i) {
                $("#chartdiv" + u).hide();}}
        $("#chartdiv" + i).show();
    }
    
    function calcMIP() {
        for (i = 0; i < MIPdens.length; i++) {
            $('#MIP' + i).val((2 * MIPdens[i] / $('#count' + i).val()).toFixed(3));}
    }
    
    function getStatus(i) {
        window.open(infoURL[i]);
    }

    function timestampToDate(timestamp) {
        var date = new Date(timestamp * 1000)
        var year = date.getUTCFullYear();
        var month = date.getUTCMonth() + 1;
        var day = date.getUTCDate();
        var hour = date.getUTCHours();
        var minute = date.getUTCMinutes();
        var second = date.getUTCSeconds();
        var datumOut = year + "/" + padZero(month, 2) + "/" + padZero(day, 2) + " " + padZero(hour, 2) + ":" + padZero(minute, 2) + ":" + padZero(second, 2);
        return datumOut;
    }
    
    function timestampToGMST(timestamp) {
        var sidDays = timestamp / 86400 - 10957;
        var GMST = 18.697374558 + 24.06570982441908 * sidDays; // http://en.wikipedia.org/wiki/Sidereal_time
        var hours = parseInt(GMST, 10);
        var minutes = (GMST - hours) * 60;
        var seconds = (minutes - parseInt(minutes)) * 60;
        seconds = (parseInt(0.5 + seconds * 10)) / 10;
        var minutes = parseInt(minutes);
        sidDays = parseInt(hours / 24, 10);
        hours = hours - 24 * sidDays;
        GMST = sidDays + " " + padZero(hours, 2) + ":" + padZero(minutes, 2) + ":" + padZero(seconds, 2);
        return GMST;
    }

    $(function() {
        var diagramColor = ["#600", "#f00", "#f90", "#ff0", "#6f0", "#6ff", "#f0f", "#ccc"];
        var traceColor = ["#222", "#D22", "#1C2", "#1CC"];
        $("#sessionHash").val(get_coincidence.session_hash);
        $("#coinInfo1").hide();
        $("#direction").hide();
    
        // start main()
    
        function main(htmlInfo, URL) {
            $.getJSON(URL + "get_coincidence/", get_coincidence, function (data) {
                // start callback getJSON
                $("#dataButton").hide();
                $("#exampleButton").hide();
                Dataflag = false;
                detNum = detectorNumber(data);
                stationNumber = data.events.length;
                makeShowerMap(htmlInfo, data);
                plotGraph(htmlInfo, data);
    
                $("#datum-id").css('visibility', 'visible');
                $("#result-id").css('visibility', 'visible');
                $("#tracelegend").css('visibility', 'visible');
                
                //  Get Year, Month, Day, Hour, Minute, Second.
                var datum = timestampToDate(data.events[0].timestamp)
                $("#datum").html(datum);
    
                // Greenwich Mean Sidereal Time in hours
                var GMST = timestampToGMST(data.events[0].timestamp)
                $("#gmst").html(GMST);

                var sidDays = data.events[0].timestamp / 86400 - 10957;
                // Write information to dashboard
                var tabWidth = 1 + data.events.length;
                var txt = "<tr><td colspan='" + tabWidth + "'>Station</td></tr><tr><td></td>";
                var txt1 = "<tr><td colspan='" + tabWidth + "'>Station</td></tr><tr><td></td>";
                for (i = 0; i < data.events.length; i++) {
                    txt += "<td onclick='getStatus(" + i + ")' style='cursor: pointer; text-align: center; border-radius: 2px; background-color:";
                    txt += diagramColor[i] + ";";
                    txt1 += "<td onclick='getStatus(" + i + ")' style='cursor: pointer; text-align: center; border-radius: 2px; background-color:";
                    txt1 += diagramColor[i] + ";";
                    if (i < 2) {
                        txt += " color:#ddddff;";
                        txt1 += " color:#ddddff;";}
                    txt += "'>" + data.events[i].number;
                    txt1 += "'>" + data.events[i].number;}
                    txt1 += "</td></tr><tr><td>dRA</td><td><input type='text' id='dRA' disabled='disabled' size=5></td></tr>";
                    txt1 += "<tr><td>dDec</td><td><input type='text' id='dDec' disabled='disabled' size=5></td></tr>";
                txt += "</td></tr><tr><td colspan='" + tabWidth + "'>Distance to shower in [m]</td></tr><tr><td></td>";
                txt1 += "<tr><td colspan='" + tabWidth + "'>Traveling delay in [ns]</td></tr><tr><td></td></tr><tr><td>Data</td>";
                for (i = 0; i < data.events.length; i++) {
                    txt += "<td><input type='text' id='dist" + i + "' disabled='disabled' size=5></td>";
                    txt1 += "<td><input id='nanoseconds" + i + "' type='text' value=" + (data.events[i].nanoseconds-data.events[0].nanoseconds);
                    txt1 += " disabled='disabled' size=5></input></td>";
                    MIPdens[i] = 0;}
                txt += "</tr><tr><td colspan='" + tabWidth + "'>Detectorflux in [MIP/m<sup>2</sup>]</td></tr>";
                for (j = 0; j < 4; j++) {
                    txt += "<tr><td align='center' class='det" + (j + 1) + "' style='border-radius:2px;'>" + (1 + j) + "</td>";
                    for (i = 0; i < data.events.length; i++) {
                        if (j < detNum[i]) {
                            if (data.events[i].pulseheights[j] * data.events[i].integrals[j] !== 0) {
                                MIPdens[i] = data.events[i].mips[j] + MIPdens[i];
                                txt += "<td><input id='MIP" + i + j + "' type='text' value=" + (2 * data.events[i].mips[j]).toFixed(3);
                                txt += " disabled='disabled' size=5></input></td>";}
                            else {
                                txt += "<td><input id='MIP" + i + j;
                                txt += "' type='text' value='no data' style='color:#f33; -webkit-text-fill-color: #f33;' disabled='disabled' size=5></input></td>";}}
                        else {
                            txt += "<td></td>";
                            txt1 += "<td></td>";}}
                    txt += "</tr>";}
                txt1 += "</tr>";
                txt += "<tr><td></td>";
                txt1 += "<tr><td></td></tr><tr><td>Calc.</td>";
                for (i = 0; i < data.events.length; i++) {
                    txt += "<td><select id='count" + i + "' onchange='calcMIP()'>";
                    txt1 += "<td><input id='nanoCalc" + i + 1 + "' type='text' disabled='disabled' size=5></input></td>";
                    for (j = detNum[i]; j > 0; j--) {
                        txt += "<option value=" + j + ">" + j + "</option>";}
                    txt += "</select></td>";}
                txt1 += "</tr><tr><td><a style='font-family: serif;'>&#967;</a><sup>2</sup>:</td>";
                txt1 += "<td><input type='text' id='dirEr' disabled='disabled' size=5></input></td></tr>";
                txt1 += "<tr><td>RA</td><td><input type='text' id='RA' disabled='disabled' size=5></input></td></tr>";
                txt1 += "<tr><td>Dec</td><td><input type='text' id='dirEr' disabled='disabled' size=5></input></td></tr>";
                txt += "</tr><tr><td colspan='" + tabWidth + "'>Stationflux in [MIP/m<sup>2</sup>]</td></tr><tr><td>Data</td>"
                for (i = 0; i < data.events.length; i++) {
                    txt += "<td><input type='text' id='MIP" + i + "' value=" + (MIPdens[i] / 2).toFixed(3) + " disabled='disabled' size=5></input></td>";}
                txt += "</tr><tr><td>Calc.</td>";
                for (i = 0; i < data.events.length; i++) {
                    txt += "<td><input type='text' id='MIPcalc" + i + "' disabled='disabled' size=5></input></td>";
                    $("#choice" + i).html(data.events[i].number).show().css('visibility', 'visible');
                    infoURL[i] = "http://data.hisparc.nl/django/show/stations/" + data.events[i].number + "/" + datum.substring(0, 10) + "/";}
                txt += "</tr>"
                $(txt).appendTo("#coinInfo");
                $(txt1).appendTo("#coinInfo1");
                $('<tr><td></td><td colspan="3"><input type="button" value="Send result" id="sendButton" onclick="sendResult()"></input></td></tr>').appendTo('#coinInfo1');

                showEvent(0);
                $("#choice").on("click", "td", function(event) {showEvent($(this).index());});
                star=zenithData(data, cat());
                makeStarMap(htmlInfo, star);
                $("#star-id").hide();
                $("#direction").hide();
                // end callback getJSON()
            });

        }

        // end main()

        function getExample() {
            $("#sessionTitle").val('example')
            $("#sessionPin").val('1337')
            $("#studentName").val('test')
            get_coincidence.session_title = $("#sessionTitle").val();
            get_coincidence.session_pin = $("#sessionPin").val();
            get_coincidence.student_name = $("#studentName").val();
            if (Dataflag) {
                main(htmlInfo, URL);}
        }

        function getData() {
            if ($("#sessionTitle").val() == "" || $("#sessionPin").val() == "" || $("#studentName").val() == "") {
                alert("Fill in each field");}
            else {
                get_coincidence.session_title = $("#sessionTitle").val();
                get_coincidence.session_pin = $("#sessionPin").val();
                get_coincidence.student_name = $("#studentName").val();
                if (Dataflag) {
                    main(htmlInfo, URL);}}
        }

        $("#exampleButton").bind('click', function (event) {
            getExample();
        });

        $("#dataButton").bind('click', function (event) {
            getData();
        });

        $("#mapFunction").bind('click', function (event) {
            if($("#map-id").css("display")=="block"){
                $("#map-id").hide();
                $("#coinInfo").hide();
                $("#star-id").show();
                $("#coinInfo1").show();
                $("#direction").show();
                $("#mapFunction").val("show earth map");}
            else{
                $("#map-id").show();
                $("#coinInfo").show();
                $("#star-id").hide();
                $("#coinInfo1").hide();
                $("#direction").hide();
                $("#mapFunction").val("show star map");}
        });

//        $("#jqplot-event-canvas").bind('click', function (event) {alert("?")});


        $(window).keypress(function (e) {
            if (e.keyCode === 13) {
                getData();}
        });

        var Dataflag = true;
    });


       $(function() {
           $("#direction").draggable({
           drag: function(event, ui) {
               $("#dRA").val(((ui.position.left-245)/3).toFixed(1));
               $("#dDec").val(((213-ui.position.top)/3).toFixed(1));
           }});
       });

// 	                var x = gridpos.x + plot._gridPadding.left + c.tooltipOffset; // use jqplot.cursor.js
// 	                var y = gridpos.y + plot._gridPadding.top + c.tooltipOffset;

  </script>
 </head>
 <body>
  <div id="graph-id">
   <div id="chartdiv" class="coincidencegraph"></div>
   <table id="choice">
    <tr>
     <td id="choice0">&nbsp;</td>
     <td id="choice1"></td>
     <td id="choice2"></td>
     <td id="choice3"></td>
     <td id="choice4"></td>
     <td id="choice5"></td>
     <td id="choice6"></td>
     <td id="choice7"></td>
    </tr>
   </table>
   <div id="chartdiv0" class="tracegraph"></div>
   <div id="chartdiv1" class="tracegraph"></div>
   <div id="chartdiv2" class="tracegraph"></div>
   <div id="chartdiv3" class="tracegraph"></div>
   <div id="chartdiv4" class="tracegraph"></div>
   <div id="chartdiv5" class="tracegraph"></div>
   <div id="chartdiv6" class="tracegraph"></div>
   <div id="chartdiv7" class="tracegraph"></div>
   <table id="tracelegend">
    <tr>
     <td class="det1">Detector 1</td>
     <td class="det2">Detector 2</td>
     <td class="det3">Detector 3</td>
     <td class="det4">Detector 4</td>
    </tr>
   </table>
  </div>
  <div id="datum-id">UTC Date: <span id="datum"></span>GMST: <span id="gmst"></span></div>
  <div id="star-id"><img src="images/direction.png" alt="" id="direction" /></div>
  <div id="map-id"></div>
  <div id="result-id">
   Energy in [eV]:
   <input type="text" id="showEn" disabled="disabled" size=8></input>
   <a style="font-family: serif;">&#967;</a><sup>2</sup>:
   <input type="text" id="showEr" disabled="disabled" size=8></input>
   <input type="button" id="mapFunction" value="show star map"></input>
  </div>
  <div id="logo"><a target="_blank" href="http://www.hisparc.nl/"><img src="http://data.hisparc.nl/media/static/header.png" /></a></div>
  <div id="dashboard">
   <form action="">
   <table>
    <tbody>
    <tr><td>Title</td><td><input type="text" id="sessionTitle"></input></td></tr>
    <tr><td>Pin</td><td><input type="text" id="sessionPin"></input></td></tr>
    <tr><td>Name</td><td><input type="text" id="studentName"></input></td></tr>
    </tbody>
   </table>
   </form>
   <input type="button" id="dataButton" value="Get data"></input>
   <input type="button" id="exampleButton" value="Get example"></input>
   <form id="info" action="">
    <table id="coinInfo">
    </table>
    <table id="coinInfo1">
    </table>
   </form>
  </div>
 </body>
</html>
