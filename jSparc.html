<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN" "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>jSparc v0.4.1</title>
  <link rel="stylesheet" type="text/css" media="screen" href="scripts/jquery.jqplot.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="scripts/openlayers.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="jSparc.css" />
  <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="http://data.hisparc.nl/media/javascript/excanvas.js"></script><![endif]-->
  <script type="text/javascript" src="scripts/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="scripts/OpenLayers.js"></script>
  <script type="text/javascript" src="scripts/jquery.jqplot.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.cursor.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasTextRenderer.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasAxisLabelRenderer.js"></script>
  <script type="text/javascript" src="scripts/plugins/jqplot.canvasAxisTickRenderer.js"></script>
  <script type="text/javascript" src="jSparc.js"></script>
  <script type="text/javascript">
    var URL = "http://data.hisparc.nl/django/jsparc/";
    var MIPdens = [];
    var infoURL = [];
    var get_coincidence = {};
    get_coincidence.session_title = "";
    get_coincidence.session_pin = "";
    get_coincidence.student_name = "";
    var htmlInfo = {
        mapId: "map-id",
        distId: "dist",
        chartId: "chartdiv",
        mipId: "MIP",
        mipCalcId: "MIPcalc",
        energyId: "showEn",
        stationEr: "showEr",
        showerEr: "measEr"};
    
    function padZero(number, length) {
        var str = '' + number;
        while (str.length < length) {
            str = '0' + str;}
        return str;
    }
    
    function showEvent(i) {
        for (u = 0; u < 8; u++) {
            if (u != i) {
                $("#chartdiv" + u).hide();}}
        $("#chartdiv" + i).show();
    }
    
    function calcMIP() {
        for (i = 0; i < MIPdens.length; i++) {
            $('#MIP' + i).val((2 * MIPdens[i] / $('#count' + i).val()).toFixed(3));}
    }
    
    function getStatus(i) {
        window.open(infoURL[i]);
    }

    function timestampToDate(timestamp) {
        var minutes = parseInt(timestamp / 60, 10);
        var seconds = timestamp - 60 * minutes;
        var hours = parseInt(minutes / 60, 10);
        minutes = minutes - 60 * hours;
        var days = parseInt(hours / 24, 10);
        hours = hours - days * 24;
        var year = parseInt(days / 365, 10);
        var leapDays = parseInt((year - 2) / 4, 10);
        var yearlength;
        if (parseInt((year - 2) / 4) == ((year - 2) / 4)) {
            yearlength = 366;}
        else {
            yearlength = 365;}
        days = days - year * 365 - leapDays;
        if (days < 0) {
            year = year - 1;
            days = days + yearlength;}
        year = year + 1970;
        for (i = 0; days > monthLength[i]; i++) {}
        var month = i;
        if ((yearlength === 366) && (month > 2)) {
            days = 1 + days - monthLength[i - 1];}
        else {
            days = days - monthLength[i - 1];}
        var datumOut = year + "/" + padZero(month, 2) + "/" + padZero(days, 2) + " " + padZero(hours, 2) + ":" + padZero(minutes, 2) + ":" + padZero(seconds, 2);
        return datumOut;
    }
    
    function timestampToGMST(timestamp) {
        var sidDays = timestamp / 86400 - 10957;
        var GMST = 18.697374558 + 24.06570982441908 * sidDays; // http://en.wikipedia.org/wiki/Sidereal_time
        hours = parseInt(GMST, 10);
        minutes = (GMST - hours) * 60;
        seconds = (minutes - parseInt(minutes)) * 60;
        seconds = (parseInt(0.5 + seconds * 10)) / 10;
        minutes = parseInt(minutes);
        sidDays = parseInt(hours / 24, 10);
        hours = hours - 24 * sidDays;
        GMST = sidDays + " " + padZero(hours, 2) + ":" + padZero(minutes, 2) + ":" + padZero(seconds, 2);
    }

    $(function () {
        var diagramColor = ["#600", "#f00", "#f90", "#ff0", "#6f0", "#6ff", "#f0f", "#ccc"];
        var traceColor = ["#222", "#D22", "#1C2", "#1CC"];
        var monthLength = [31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365];
        $("#sessionHash").val(get_coincidence.session_hash);
    
        // start main()
    
        function main(htmlInfo, URL) {
            $.getJSON(URL + "get_coincidence/", get_coincidence, function (data) {
    
                // start callback getJSON
    
                stationNumber = data.events.length;
                makeShowerMap(htmlInfo, data);
                plotGraph(htmlInfo, data);
                // interactionTrace(data);
    
                $("#datum-id").css('visibility', 'visible');
                $("#result-id").css('visibility', 'visible');
                $("#tracelegend").css('visibility', 'visible');

                //  Get Year, Month, Day, Hour, Minute, Second.
                var datum = timestampToDate(data.events[0].timestamp)
                $("#datum").val(datum);
    
                // Greenwich Mean Sidereal Time in hours
                var GMST = timestampToGMST(data.events[0].timestamp)
                $("#gmst").val(GMST);
    
                // Write information to dashboard
    
                var dataeventslength = data.events.length;
                var tabWidth = 1 + dataeventslength;
                var txt = "<tr><td colspan='" + tabWidth + "'>Station</td></tr><tr><td></td>";
                for (i = 0; i < dataeventslength; i++) {
                    txt += "<td onclick='getStatus(" + i + ")' style='cursor: pointer; text-align: center; border-radius: 2px; background-color:" + diagramColor[i] + ";";
                    if (i < 2) {
                        txt += " color:#ddddff;";}
                    txt += "'>";
                    txt += data.events[i].number;}
                txt += "</td></tr><tr><td colspan='" + tabWidth + "'>Distance to shower in [m]</td></tr><tr><td></td>";
                for (i = 0; i < dataeventslength; i++) {
                    txt += "<td><input type='text' id='dist" + i + "' disabled='disabled' size=5></td>";
                    MIPdens[i] = 0;}
                txt += "</tr><tr><td colspan='" + tabWidth + "'>Detectorflux in [MIP/m<sup>2</sup>]</td></tr>";
                for (j = 0; j < 4; j++) {
                    txt += "<tr><td align='center' bgcolor='" + traceColor[j] + "' style='border-radius:2px";
                    if (j < 2) {
                        txt += "; color:#ddddff"}
                    txt += ";'>" + (1 + j) + "</td>";
                    for (i = 0; i < dataeventslength; i++) {
                        if (j < data.events[i].pulseheights.length) {
                            if (data.events[i].pulseheights[j] * data.events[i].integrals[j] !== 0) {
                                MIPdens[i] = data.events[i].mips[j] + MIPdens[i];
                                txt += "<td><input id='MIP" + i + j + "' type='text' value=" + (2 * data.events[i].mips[j]).toFixed(3) + " disabled='disabled' size=5></input></td>";}
                            else {
                                txt += "<td><input id='MIP" + i + j + "' type='text' value='no data' style='color:#ff0000' disabled='disabled' size=5></input></td>";}}
                        else {
                            txt += "<td></td>";}}
                    txt += "</tr>"}
                txt += "<tr><td></td>";
                for (i = 0; i < dataeventslength; i++) {
                    txt += "<td><select id='count" + i + "' onchange='calcMIP()'>";
                    for (j = data.events[i].traces.length; j > 0; j--) {
                        txt += "<option value=" + j + ">" + j + "</option>";}
                    txt += "</select></td>";}
                txt += "</tr><tr><td colspan='" + tabWidth + "'>Stationflux in [MIP/m<sup>2</sup>]</td></tr><tr><td>Data</td>"
                for (i = 0; i < dataeventslength; i++) {
                    txt += "<td><input type='text' id='MIP" + i + "' value=" + (MIPdens[i] / 2).toFixed(3) + " disabled='disabled' size=5></input></td>";}
                txt += "</tr><tr><td>Calc.</td>";
                for (i = 0; i < dataeventslength; i++) {
                    txt += "<td><input type='text' id='MIPcalc" + i + "' disabled='disabled' size=5></input></td>";
                    $("#choice" + i).html(data.events[i].number).show().css('visibility', 'visible');
                    infoURL[i] = "http://data.hisparc.nl/django/show/stations/" + data.events[i].number + "/" + year + "/" + month + "/" + days + "/";}
                $(txt).appendTo("#coinInfo");
                $('<input type="button" value="Send result" id="sendButton" onclick="sendResult()"></input>').appendTo('#info');
                $("#dataButton").hide();
                showEvent(0);

                // end callback getJSON()
            });

            $("#choice0").bind('click', function (event) {showEvent(0);});
            $("#choice1").bind('click', function (event) {showEvent(1);});
            $("#choice2").bind('click', function (event) {showEvent(2);});
            $("#choice3").bind('click', function (event) {showEvent(3);});
            $("#choice4").bind('click', function (event) {showEvent(4);});
            $("#choice5").bind('click', function (event) {showEvent(5);});
            $("#choice6").bind('click', function (event) {showEvent(6);});
            $("#choice7").bind('click', function (event) {showEvent(7);});
        }

        // end main()

        $("#dataButton").bind('click', function (event) {
            getData();
        });

        $(window).keypress(function (e) {
            if ((e.keyCode === 13) && ($("#studentName").val() !== "")) {
                getData();}
        });

        var Dataflag = true;

        function getData() {
            if ($("#sessionTitle").val() == "" || $("#sessionPin").val() == "" || $("#studentName").val() == "") {
                alert("Fill in each field");
            }
            else {
                get_coincidence.session_title = $("#sessionTitle").val();
                get_coincidence.session_pin = $("#sessionPin").val();
                get_coincidence.student_name = $("#studentName").val();
                if (Dataflag) {
                    main(htmlInfo, URL);
                    Dataflag = false;}
            }
        }
    });
  </script>
 </head>
 <body>
  <div id="graph-id">
   <div id="chartdiv" class="coincidencegraph"></div>
   <table id="choice">
    <tr>
     <td id="choice0">&nbsp;</td>
     <td id="choice1"></td>
     <td id="choice2"></td>
     <td id="choice3"></td>
     <td id="choice4"></td>
     <td id="choice5"></td>
     <td id="choice6"></td>
     <td id="choice7"></td>
    </tr>
   </table>
   <table id="tracelegend">
    <tr>
     <td bgcolor="#222" style="color:#ddf">Detector 1</td>
     <td bgcolor="#D22" style="color:#ddf">Detector 2</td>
     <td bgcolor="#1C2">Detector 3</td>
     <td bgcolor="#1CC">Detector 4</td>
    </tr>
   </table>
   <div id="chartdiv0" class="tracegraph"></div>
   <div id="chartdiv1" class="tracegraph"></div>
   <div id="chartdiv2" class="tracegraph"></div>
   <div id="chartdiv3" class="tracegraph"></div>
   <div id="chartdiv4" class="tracegraph"></div>
   <div id="chartdiv5" class="tracegraph"></div>
   <div id="chartdiv6" class="tracegraph"></div>
   <div id="chartdiv7" class="tracegraph"></div>
  </div>
  <div id="datum-id">Date:<input type="text" id="datum" disabled="disabled" size=22></input> GMST:<input type="text" id="gmst" disabled="disabled" size=20></input></div>
  <div id="map-id"></div>
  <div id="result-id">Energy in [eV]:<input type="text" id="showEn" disabled="disabled" size=8></input> <a style="font-family: serif;">&#967;</a><sup>2</sup>:<input type="text" id="showEr" disabled="disabled" size=8></input></div>
  <div id="logo"><a target="_blank" href="http://www.hisparc.nl/"><img src="http://data.hisparc.nl/media/static/header.png" /></a></div>
  <div id="dashboard">
   <form action="">
   <table>
    <tbody>
    <tr><td>Title</td><td><input type="text" id="sessionTitle"></input></td></tr>
    <tr><td>Pin</td><td><input type="text" id="sessionPin"></input></td></tr>
    <tr><td>Name</td><td><input type="text" id="studentName"></input></td></tr>
    </tbody>
   </table>
   </form>
   <input type="button" id="dataButton" value="Get data" onclick="getData()"></input>
   <form id="info" action="">
    <table id="coinInfo">
    </table>
   </form>
  </div>
 </body>
</html>
