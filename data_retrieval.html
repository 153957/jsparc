<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>HiSPARC - jSparc - Data retrieval</title>
        <link rel="icon" type="image/vnd.microsoft.icon" href="images/favicon.ico">
        <link rel="stylesheet" type="text/css" href="styles/jquery-ui-1.10.3.custom.css" />
        <link rel="stylesheet" type="text/css" href="styles/jquery-ui-timepicker-addon.css" />
        <link rel="stylesheet" type="text/css" href="styles/data_retrieval.css" />
        <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="scripts/excanvas.js"></script><![endif]-->
        <script type="text/javascript" src="scripts/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="scripts/jquery-ui-1.10.3.custom.js"></script>
        <script type="text/javascript" src="scripts/jquery-ui-timepicker-addon.js"></script>
        <script type="text/javascript" src="scripts/jquery.flot.js"></script>
        <script type="text/javascript" src="scripts/jquery.flot.time.js"></script>
        <script type="text/javascript" src="scripts/jquery.flot.log.js"></script>
        <script type="text/javascript" src="scripts/jquery.flot.canvas.js"></script>
        <script type="text/javascript" src="scripts/jquery.flot.axislabels.js"></script>
        <script type="text/javascript" src="scripts/regression.js"></script>
        <script type="text/javascript" src="jquery.jsparc.js"></script>
        <!-- Add MathJax to enhance the look of the fit formulas -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script>
            var jsparc;
            $(document).ready(function () {
                // Animate HiSPARC logo during ajax activity
                $(document).bind('ajaxSend', function() {
                    $('#pageHeader').addClass('animated');})
                           .bind('ajaxComplete', function() {
                    $('#pageHeader').removeClass('animated');});

                // Load jSparc library
                jsparc = $.jsparc();

                station_events_select = jsparc.make_station_select($('#station_events_choice'), 'events');
                station_weather_select = jsparc.make_station_select($('#station_weather_choice'), 'weather');
                jsparc.make_datepicker($('#startdate_choice'), -2);
                jsparc.make_datepicker($('#enddate_choice'), -1);
                jsparc.set_dataset_list_controls($('#dataset_list'));
                jsparc.set_flot_options([jsparc.flot_scatter()]);

                // Show station list for specific data type
                $('#type_choice input').change(function() {
                    if ($(this).val() == 'weather') {
                        $('#station_events_choice').hide();
                        $('#station_weather_choice').show();}
                    else if ($(this).val() == 'events') {
                        $('#station_events_choice').show();
                        $('#station_weather_choice').hide();}
                });

                // Synchronize the two station choice lists
                $('#station_choice').on('change', 'select', function() {
                    $('#station_choice select').val($(this).val());
                });

                // Recheck all radio buttons that were checked before loading new data
                // This function does only work for the specific 'select data' radio buttons
                function recheck_buttons(array) {
                    $.each(array, function(key, value){
                        $('#select_dataset table input:radio[name=' + key + '][value="' + value + '"]').prop("checked", true);
                    });
                }

                // Download button
                $('#download_dataset').on('click', function() {
                    var data_type = $('#type_choice input:checked').val()
                    var input_array = {};
                    var checked_input = $('#select_dataset table input:checked');

                    // Make sure check_input exists
                    if (typeof checked_input != "undefined") {
                        for (var i = 0; i < checked_input.length; i++) {
                            input_array[checked_input[i]["name"]] = checked_input[i]["value"];
                        }
                    }                    

                    var download_return = jsparc.download_dataset($('#station_' + data_type + '_choice select').val(),
                                            $('#startdate_choice').val(),
                                            $('#enddate_choice').val(),
                                            data_type)
                          
                    // Check return type because if for example dataset is already available
                    // the object return is not a reader object
                    if (typeof download_return != "undefined") {
                        download_return.done(function(data) {
                            recheck_buttons(input_array);
                            $('#select_dataset').show();});}
                });

                // Load data button
                $('#load_dataset').on('click', function() {
                    // Remember all checked input
                    // Create array to store name and value of checked input, because key should be unique we use name as key
                    var input_array = {};
                    var checked_input = $('#select_dataset table input:checked');

                    // Make sure check_input exists
                    if (typeof checked_input != "undefined") {
                        for (var i = 0; i < checked_input.length; i++) {
                            input_array[checked_input[i]["name"]] = checked_input[i]["value"];
                        }
                    }

                    var reader_return = jsparc.load_dataset($('#file_choice')[0].files[0]);

                    // Check return type because if for example dataset is already available
                    // the object return is not a reader object
                    if (typeof reader_return != "undefined") {
                        reader_return.onloadend = function() {
                            recheck_buttons(input_array);
                            $('#select_dataset').show();};}
                });

                // Show plot button
                $('#make_plot').on('click', function() {
                    var x = $('#select_variables input[name=x-axis]:checked'),
                        y = $('#select_variables input[name=y-axis]:checked'),
                        xset = x.parents('table').attr('name'),
                        yset = y.parents('table').attr('name'),
                        ylog = $("#plot_y_axis :checked").val() !== 'none',
                        xlog = $("#plot_x_axis :checked").val() !== 'none',
                        data_to_plot;
                    // Here the plot data is prepared, each section results in
                    // a multidimensional array `data_to_plot`
                    // [[[x, y], [x, y], ...], [set2], ...]
                    if ($('#plot_type input:checked').val() == 'histogram') {
                        jsparc.add_flot_options(jsparc.flot_x_axis_labels(x.data('label')));
                        jsparc.add_flot_options(jsparc.flot_y_axis_labels('Counts'));
                        var x_data = jsparc.get_column(x.val(), xset);

                        // Filter error values before determining bins and making the histogram
                        if (x_data[0] instanceof Array) {
                            for (var i = 0; i < x_data.length; i++) {
                                x_data[i] = jsparc.remove_error_values_1d(x_data[i]);
                                if (xlog) {
                                    x_data[i] = jsparc.remove_invalid_log_values_1d(x_data[i]);}}}
                        else {
                            x_data = jsparc.remove_error_values_1d(x_data);
                            if (xlog) {
                                x_data = jsparc.remove_invalid_log_values_1d(x_data);}}

                        var hist = jsparc.histogram(x_data, parseInt($('#hist_bins input').val()));

                        if (hist[1][0] === undefined) {
                            // If there are no bins
                            data_to_plot = [[]]}
                        else {
                            // Add another bin at the end (can mess up a fit)
                            if (hist[0][0] instanceof Array) {
                                for (var i = 0; i < hist[0].length; i++) {
                                    hist[0][i].push(hist[0][i][hist[0][i].length - 1])}}
                            else {
                                hist[0].push(hist[0][hist[0].length - 1])}
                            var n_bins = hist[1].length,
                                bin_width = (hist[1][n_bins - 1] - hist[1][n_bins - 2]);
                            hist[1].push(hist[1][n_bins - 1] + bin_width);

                            // The data that needs to be plotted
                            data_to_plot = jsparc.zip_data(hist[1], hist[0]);

                            if (data_to_plot[0][0] instanceof Array == false) {
                                data_to_plot = [data_to_plot]}}
                    }
                    else if ($('#plot_type input:checked').val() == 'scatter') {
                        jsparc.add_flot_options(jsparc.flot_x_axis_labels(x.data('label')));
                        jsparc.add_flot_options(jsparc.flot_y_axis_labels(y.data('label')));
                        if (xset != yset) {
                            var y_data = jsparc.linear_interpolation(jsparc.get_ext_timestamp(xset),
                                                                     jsparc.get_ext_timestamp(yset),
                                                                     jsparc.get_column(y.val(), yset))}
                        else {
                            var y_data = jsparc.get_column(y.val(), yset)}

                        // The data that needs to be plotted
                        data_to_plot = jsparc.zip_data(jsparc.get_column(x.val(), xset), y_data);

                        if (data_to_plot[0][0] instanceof Array == false) {
                            data_to_plot = [data_to_plot]}

                        for (var i = 0; i < data_to_plot.length; i++) {
                            if (ylog) {
                                data_to_plot[i] = jsparc.remove_invalid_log_values(data_to_plot[i], 1)}
                            if (xlog) {
                                data_to_plot[i] = jsparc.remove_invalid_log_values(data_to_plot[i], 0)}}
                    }
                    else if ($('#plot_type input:checked').val() == 'timeseries') {
                        jsparc.add_flot_options(jsparc.flot_y_axis_labels(y.data('label')));

                        // The data that needs to be plotted
                        var y_data = jsparc.get_column(y.val(), yset),
                            x_data = jsparc.make_javascript_timestamp(jsparc.get_column('timestamp', yset));
                        data_to_plot = jsparc.zip_data(x_data, y_data);

                        if (data_to_plot[0][0] instanceof Array == false) {
                            data_to_plot = [data_to_plot]}

                        if (ylog) {
                            for (var i = 0; i < data_to_plot.length; i++) {
                                data_to_plot[i] = jsparc.remove_invalid_log_values(data_to_plot[i], 1)}}
                    }

                    for (var i = 0; i < data_to_plot.length; i++) {
                        data_to_plot[i] = jsparc.remove_error_values(data_to_plot[i])}

                    if (jsparc.is_data_empty(data_to_plot)) {
                        alert('No data to plot. The selected data may contain only error values or invalid values for logarithmic axes.');
                        return}

                    // Get selected fit options
                    var fit_type = $("#fit_options").val(),
                        degree = parseInt($('#fit input').val());

                    // If a fit type is selected use regression.js to get trend 
                    // points and add them to data to plot
                    if (fit_type != 'none') {
                        var formulas = $('<div>').append($('<h3>').text('Fit formula with correlation coefficient'));
                        // Check for multidimensional array
                        // Loop over each single dataset
                        var length = data_to_plot.length;
                        for (var i = 0; i < length; i++) {
                            // And for each dataset calculate the fit
                            var summary = regression(fit_type, data_to_plot[i], degree);

                             // Only show fit if NaN not present
                            if (summary.string.indexOf("NaN") != -1) {
                                summary.string = "Fit not possible"
                                summary.corrstring = "";}

                            // The calculated fit is returned as summary.points
                            data_to_plot.push(summary.points);
                            formula = $('<p>');
                            formula.append($('<span>').addClass('formula').text(summary.string));
                            formula.append($('<span>').addClass('correlation').text(summary.corrstring));
                            formulas.append(formula);}
                        $("#preview").html(formulas);
                        $("#results").show();
                        // Update MathJax to render new text
                        MathJax.Hub.Queue(["Typeset", MathJax.Hub, "results"]);}
                    else {
                        $("#results").hide();}

                    // Create the plot
                    plot = jsparc.make_plot($('#plot'), data_to_plot);

                    $('#plot').show();
                    $('#graph').show();
                    jsparc.show_id('plot');
                });

                // Show trace button
                $('#preview').on('click', 'td.trace', function() {
                    $('#preview tr.selectedEvent').removeClass('selectedEvent');
                    $(this).parent().addClass('selectedEvent');
                    var url = $(this).attr('data-url');
                    jsparc.get_json(url).done(function(data) {
                        // Set plot options
                        jsparc.set_flot_options([]);
                        jsparc.add_flot_options(jsparc.flot_x_axis_labels('Time [ns]'));
                        jsparc.add_flot_options(jsparc.flot_y_axis_labels('ADCcounts'));
                        var x_data = jsparc.range(0, 2.5 * data[0].length, 2.5);
                        plot = jsparc.make_plot($('#plot'), jsparc.zip_data(x_data, data));
                        $('#plot').show();
                        $('#graph').show();
                        jsparc.show_id('plot');
                        jsparc.set_flot_options($('#plot_settings input:checked').map(function () {return eval('jsparc.flot_' + $(this).val())()}));
                    })
                });

                // Dataset list buttons
                $('#dataset_list').on('click', '.preview', function() {
                    jsparc.create_dataset_table($(this).attr('name'),
                                                $('#preview'), 29);
                    $('#results').show();
                    jsparc.show_id('preview');
                });

                $('#dataset_list').on('click', '.download', function() {
                    window.open($(this).attr('name'), '_blank');
                });

                // Radio buttons
                $('#dataset_list').on('change', 'input', function() {
                    jsparc.make_variable_plot_table($(this).val(), $('#' + $(this).attr('name') + '_variables'));
                    $('#plot_type input:checked').trigger('change');
                    $('#select_variables').show();
                });

                $('#select_variables').on('change', 'input', function() {
                    $('#controls').show();
                });

                $('#plot_type').on('change', 'input', function() {
                    if ($(this).val() == 'histogram') {jsparc.enable_radio_set('x-axis');
                                                       jsparc.disable_radio_set('y-axis');
                                                        $('#hist_bins input').prop('disabled', false);}
                    else if ($(this).val() == 'scatter') {jsparc.enable_radio_set('x-axis');
                                                          jsparc.enable_radio_set('y-axis');
                                                           $('#hist_bins input').prop('disabled', true);}
                    else if ($(this).val() == 'timeseries') {jsparc.disable_radio_set('x-axis');
                                                             jsparc.enable_radio_set('y-axis');
                                                              $('#hist_bins input').prop('disabled', true);}
                });

                // Set Degree to disabled if polynomial not selected
                $("#fit_options").on('change', function(){
                    if ($(this).val() != "polynomial") {
                        $('#fit input').prop('disabled', true);
                    } else {
                        $('#fit input').prop('disabled', false);
                    }
                });

                // Update plot settings
                $('#plot_settings').on('change', 'input', function() {
                    jsparc.set_flot_options($('#plot_settings input:checked').map(function () {return eval('jsparc.flot_' + $(this).val())()}));
                });
            });
        </script>
    </head>
    <body>
    <div id="container">
        <div id="header"><div id="pageHeader"></div></div>
        <div id="doc_link">
            <a href="http://docs.hisparc.nl/jsparc/data_retrieval.html" target="jsparc_doc">➔ Documentation</a>
        </div>
        <div id="download_data">
            <h2>Download data</h2>
            <p>Get data from the HiSPARC server.</p>
            <p>Data type:
                <span id="type_choice">
                    <input name="data_type" type="radio" value="events" checked="checked"> Events
                    <input name="data_type" type="radio" value="weather"> Weather
                </span>
            </p>
            <p id="station_choice">Station:
                <span id="station_events_choice"><select><option>Loading stations..</option></select></span>
                <span style="display:none;" id="station_weather_choice"></span></p>
            <p>Start date: <input id="startdate_choice" type="datetime"></p>
            <p>End date: <input id="enddate_choice" type="datetime"></p>
            <input type='button' value="Get Data!" id="download_dataset">
        </div>
        <div id="load_data">
            <h2>Load local file</h2>
            <p>Import a downloaded .csv file (tab-separated values).</p>
            <p><input id="file_choice" type="file" accept="text/csv"></p>
            <input type='button' value="Load Data!" id="load_dataset">
        </div>
        <div class="clear"></div>
        <div id="select_dataset">
            <h3>Select datasets to use</h3>
            <p id="dataset_list"></p>
        </div>
        <div id="select_variables">
            <h3>Select variables and settings to plot</h3>
            <div id="controls" class="left">
                <div id="plot_settings">
                    <span class="key">Plot type:</span><br>
                    <span id="plot_type">
                        <input name="plot_type" type="radio" value="scatter" checked> Scatter<br>
                        <input name="plot_type" type="radio" value="histogram"> Histogram<br>
                        <input name="plot_type" type="radio" value="timeseries"> Time series<br>
                    </span><br>
                    <span class="key">x-Axis:</span><br>
                    <span id="plot_x_axis">
                        <input name="plot_x_axis" type="radio" value="none" checked> Linear<br>
                        <input name="plot_x_axis" type="radio" value="xlog"> Logarithmic<br>
                    </span><br>
                    <span class="key">y-Axis:</span><br>
                    <span id="plot_y_axis">
                        <input name="plot_y_axis" type="radio" value="none" checked> Linear<br>
                        <input name="plot_y_axis" type="radio" value="ylog"> Logarithmic<br>
                    </span><br>
                    <span class="key">Histogram:</span><br>
                    <span id="hist_bins">
                        Bins: <input name="hist_bins" type="number" min=0 step=10 style="width: 60px;" value="100"><br>
                    </span><br>
                    <span class="key">Fit:</span><br>
                    <span id="fit"> 
                        Type:   
                        <select id="fit_options">
                            <option value="none">No fit</option>
                            <option value="linear">Linear</option>
                            <option value="gaussian">Gaussian</option>
                            <option value="exponential">Exponential</option>
                            <option value="wexponential">Exponential*</option>
                            <option value="logarithmic">Logarithmic</option>
                            <option value="power">Power</option>
                            <option value="polynomial">Polynomial</option>
                        </select>
                        Degree: <input name="degree" type="number" min=0 max=10 step=1 style="width: 60px;" disabled value="2"><br>      
                    </span><br>
                </div>
                <input type="button" value="Create Plot" id="make_plot">
            </div>
            <div id="set1_variables" class="left"></div>
            <div id="set2_variables" class="left"></div>
        </div>
        <div class="clear"></div>
        <div id="graph">
            <h3>Plot</h3>
            <a onclick="jsparc.download_plot()" class="save_image right">Save image</a>
            <div id="plot"></div>
        </div>
        <div id="results">
            <p id="preview"></p>
        </div>
    </div>
    </body>
</html>
