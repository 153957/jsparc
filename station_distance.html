<!doctype html>
<html>
    <head>
        <link rel="icon" type="image/vnd.microsoft.icon" href="images/favicon.ico" />
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>HiSPARC Station map</title>
        <link rel="stylesheet" media="all" href="styles/OpenLayers-2.12.css" />
        <link rel="stylesheet" media="all" href="styles/map_controls.css" />
        <link rel="stylesheet" media="all" href="styles/station_distance.css" />
        <script src="scripts/jquery-1.10.2.min.js"></script>
        <script src="scripts/OpenLayers-2.13b.min.js"></script>
        <script src="scripts/OpenLayersHisparcMap.js"></script>
        <script src="jquery.jsparc.js"></script>
        <script>
            var jsparc, map;

            function update_map(station1, station2) {
                var station_layer = map.getLayersByName('hisparc-stations')[0];
                station_layer.removeAllFeatures();

                var pnt1 = new OpenLayers.Geometry.Point(station1.longitude, station1.latitude).transform(fromProjection, toProjection),
                    pnt2 = new OpenLayers.Geometry.Point(station2.longitude, station2.latitude).transform(fromProjection, toProjection),
                    feature1 = new OpenLayers.Feature.Vector(pnt1, {id: station1.number, name: station1.number + " - " + station1.name, status: "up"}),
                    feature2 = new OpenLayers.Feature.Vector(pnt2, {id: station2.number, name: station2.number + " - " + station2.name, status: "up"});
                station_layer.addFeatures([feature1, feature2]);

                // Zoom to fit cluster
                var bounds = station_layer.getDataExtent();
                if (bounds) {
                    map.zoomToExtent(bounds);
                    map.zoomTo(Math.floor(map.getZoom()));}
                }

            $(document).ready(function() {

                // Load jSparc library
                jsparc = $.jsparc();

                // Make the two station lists
                jsparc.make_station_select($('#station_choice_1'));
                jsparc.make_station_select($('#station_choice_2'));

                // Update map when a new station is selected
                $('#station_choice').on('change', 'select', function() {
                    var station_info_urls = [jsparc.api_station_info($('#station_choice_1 select').val()),
                                             jsparc.api_station_info($('#station_choice_2 select').val())];
                    var results = jsparc.get_multiple_json(station_info_urls);
                    results.done(function(s1, s2) {update_map(s1[0], s2[0]);});
                });

                // Create the map
                map = createMap("map");
                var style = createStyle(map);

                map.setCenter(new OpenLayers.LonLat(4.950, 52.355).transform(fromProjection, toProjection), 5);

                var station_layer = new OpenLayers.Layer.Vector("hisparc-stations", {styleMap: new OpenLayers.StyleMap(style)});
                map.addLayer(station_layer);

            });
        </script>
    </head>

    <body>
        <div id="header"><div id="pageHeader"></div></div>
        <div id="menu">
            <p id="station_choice">
                Distance between station
                <span id="station_choice_1"><select><option>Loading stations..</option></select></span>
                and station
                <span id="station_choice_2"><select><option>Loading stations..</option></select></span>
            </p>
        </div>
        <div id="map"></div>
    </body>

</html>
